<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.1.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico"><link rel="mask-icon" href="/images/logo_monkey.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("http://blog.fengsq.com").hostname,root:"/",scheme:"Muse",version:"7.6.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:-1,unescape:!1,preload:!1},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="相信大家一开始做安卓开发就知道apk需要签名，但是有多少人真的知道Android的签名是什么呢？今天我们就一起来聊聊Android签名的前世今生。"><meta property="og:type" content="article"><meta property="og:title" content="一次让你搞懂Android应用签名"><meta property="og:url" content="http:&#x2F;&#x2F;blog.fengsq.com&#x2F;ApkSignature.html"><meta property="og:site_name" content="Qian&#39;s blog"><meta property="og:description" content="相信大家一开始做安卓开发就知道apk需要签名，但是有多少人真的知道Android的签名是什么呢？今天我们就一起来聊聊Android签名的前世今生。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;new-key-store.jpg"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;signed-apk.jpg"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;Scheme1v2.png"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;verify_sha.png"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;apk-before-after-signing.png"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;apk-sections.png"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;apk-integrity-protection.png"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;find-sign-block.jpg"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;x-android-apk-signed.jpg"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;apk-v2-validation.png"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;Lineage.png"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;APK-sign-block.jpg"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;apk-validation-process.png"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;v3SignatureError.jpg"><meta property="og:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;keystore-password-recover.jpg"><meta property="article:published_time" content="2019-12-11T02:05:32.000Z"><meta property="article:modified_time" content="2019-12-13T02:48:53.298Z"><meta property="article:author" content="FengShiqian"><meta property="article:tag" content="Android"><meta property="article:tag" content="签名"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;android-tech.oss-cn-shenzhen.aliyuncs.com&#x2F;signature&#x2F;new-key-store.jpg"><link rel="canonical" href="http://blog.fengsq.com/ApkSignature.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>一次让你搞懂Android应用签名 | Qian's blog</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Qian's blog" type="application/atom+xml">
</head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Qian's blog</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://blog.fengsq.com/ApkSignature.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="FengShiqian"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Qian's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">一次让你搞懂Android应用签名</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-12-11 10:05:32" itemprop="dateCreated datePublished" datetime="2019-12-11T10:05:32+08:00">2019-12-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-12-13 10:48:53" itemprop="dateModified" datetime="2019-12-13T10:48:53+08:00">2019-12-13</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span> </a></span></span><span id="/ApkSignature.html" class="post-meta-item leancloud_visitors" data-flag-title="一次让你搞懂Android应用签名" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/ApkSignature.html#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/ApkSignature.html" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><p>相信大家一开始做安卓开发就知道apk需要签名，但是有多少人真的知道Android的签名是什么呢？<br></p><p>今天我们就一起来聊聊Android签名的前世今生。</p><a id="more"></a><h2 id="一、签名是什么？"><a href="#一、签名是什么？" class="headerlink" title="一、签名是什么？"></a>一、签名是什么？</h2><p>正如我们平时生活中办理业务、签合同等都需要本人的签名以证实身份。应用的签名，也是为了验证这个应用是否被篡改，是否是该应用的所有者发布的等。Android的证书通常是自签名的，也就是开发者可以自己创建，不需要向CA机构申请。系统认为某个包名的应用第一次安装时的证书就是合法的。签名有以下几个作用：</p><ol><li><strong>应用程序升级</strong>：相同包名的应用必须有相同的签名才能覆盖安装。各大应用市场通常也是通过你是否拥有应用正确的签名判断你是不是应用的所有者。</li><li><strong>应用程序模块化</strong>：Android系统可以允许同一个证书签名的多个应用程序在一个进程里运行，系统实际把他们作为一个单个的应用程序，此时就可以把我们的应用程序以模块的方式进行部署。</li><li><strong>代码或者数据共享</strong>：Android提供了基于签名的权限机制，一个应用程序可以为另一个以相同证书签名的应用程序公开自己的功能。</li><li><strong>安全性校验</strong>：使用第三方服务（如微信）会校验应用的签名，如果签名不对无法调用。自己App内的某些关键位置也可以增加签名校验（最好放在native中），签名不正确直接退出或报错，防止别人二次打包。</li></ol><p>任何一个APK都必须签名后才能安装到手机上。有人可能会说，我在AS中直接run的时候，并没有进行签名啊，其实这时候会默认使用一个debug签名，mac上debug签名的路径是<code>/Users/xxx/.android/debug.keystore</code>，windows在<code>C:\Users\xxx\.android\debug.keystore</code>。细心的同鞋可能会发现，在一台电脑上运行了一个程序到一个设备，换一台电脑运行到这个设备时无法直接覆盖安装，会提示先卸载原来的，正是由于两台电脑的debug签名是不同的，如果想要可以覆盖安装，可以配置debug时都使用同一个签名而不使用默认的，或者将一台电脑的debug.keystore拷贝到另一台电脑对应位置。<br></p><p>debug.keystore信息如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Keystore name: &quot;debug.keystore&quot;</span><br><span class="line">Keystore password: &quot;android&quot;</span><br><span class="line">Key alias: &quot;androiddebugkey&quot;</span><br><span class="line">Key password: &quot;android&quot;</span><br><span class="line">CN: &quot;CN&#x3D;Android Debug,O&#x3D;Android,C&#x3D;US&quot;</span><br></pre></td></tr></table></figure><p>而Android 支持以下三种应用签名方案：</p><ol><li><strong>v1 方案</strong>：基于 JAR 签名。</li><li><strong>v2 方案</strong>：APK 签名方案 v2（在 Android 7.0 中引入）。</li><li><strong>v3 方案</strong>：APK 签名方案 v3（在 Android 9.0 中引入）。</li></ol><p>后面会对它们一一介绍。</p><h2 id="二、预备知识"><a href="#二、预备知识" class="headerlink" title="二、预备知识"></a>二、预备知识</h2><p>在开始介绍Android的签名之前，先简单普及三个知识点，在签名中会用到的技术。这里不做详细介绍，如果大家感兴趣，后面可以单独搞一篇。</p><h3 id="2-1-非对称加密算法"><a href="#2-1-非对称加密算法" class="headerlink" title="2.1 非对称加密算法"></a>2.1 非对称加密算法</h3><blockquote><p>非对称密钥加密算法需要一个公钥-私钥对，称为key pair。常用公钥加密算法是RSA和DSA。</p></blockquote><p>从功能上说，两个key 作用相同，用一个 key加密的消息，只能用另一个 key 解密，反之亦然。两个 key 的区别只在于谁拥有（知道）它：私钥只有 key pair 的生成者知道，公钥则公开。key pair的另一个特性是无法从一个key推算出另一个key。</p><h3 id="2-2-数字摘要"><a href="#2-2-数字摘要" class="headerlink" title="2.2 数字摘要"></a>2.2 数字摘要</h3><p>数字摘要算法是使用一个Hash函数对任意长度的输入数据进行处理，输出固定长度的数据，输出数据称为消息摘要。无法从消息摘要倒推出消息内容。常用的消息摘要算法是 MD5 和 SHA-1。</p><h3 id="2-3-数字签名"><a href="#2-3-数字签名" class="headerlink" title="2.3 数字签名"></a>2.3 数字签名</h3><blockquote><p>数字签名是只有信息的发送者才能产生的别人无法伪造的一段数字串，以证实信息的真实性。数字签名通过非对称加密技术和数字摘要技术实现。</p></blockquote><ol><li>生成 key pair</li><li>签名：对消息进行摘要获得其Hash值，用私钥加密消息Hash获得数字签名</li><li>验证：对消息进行摘要获得其Hash值，用公钥解开数字签名获得消息Hash，对两个Hash进行比对</li></ol><p>由于私钥无法伪造或从公钥推算出，因此，消息发送者必为私钥拥有者，由此确保了消息来源的真实性和不可否认性。如果消息在发送过程中损坏或被篡改，进行摘要后Hash值必定不一致，数字签名验证无法通过，由此确保了消息内容的完备性。</p><h2 id="三、v1-方案（jar-签名）"><a href="#三、v1-方案（jar-签名）" class="headerlink" title="三、v1 方案（jar 签名）"></a>三、v1 方案（jar 签名）</h2><blockquote><p>基于上面介绍的3个知识点，下面就来介绍Android最早使用的签名-jar签名</p></blockquote><h3 id="3-1-工具介绍"><a href="#3-1-工具介绍" class="headerlink" title="3.1 工具介绍"></a>3.1 工具介绍</h3><p>由于 apk 和 jar 实际上都是 zip 文件结构，所以Android早期的签名直接使用了jar包的签名方案，JDK 提供了 keytool 和 jarsigner 两个工具用来进行 Jar 包签名和验证。</p><ol><li>keytool 用来生成和管理 keystore。</li><li>jarsigner 读取 keystore，为 Jar 包进行数字签名，也可以对签名的 Jar 包进行验证。</li></ol><p><em>keystore 是一个数据文件，存储了 key pair 有关的2种数据：私钥和证书，而证书包含了公钥。整个 keystore 用一个密码进行保护，keystore 里面的每一对 key pair 单独用一个密码进行保护。每对 key pair 用一个 alias 进行指定，alias 不区分大小写。</em></p><h3 id="3-2-签名步骤"><a href="#3-2-签名步骤" class="headerlink" title="3.2 签名步骤"></a>3.2 签名步骤</h3><ol><li>生成签名文件（密钥库）</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -keystore demo.jks -alias demo -validity 3650</span><br></pre></td></tr></table></figure><p>执行以上命令，按照提示一步步输入信息，就可以创建一个名为 demo.jks 的签名文件（密钥库），密钥的 alias 为 demo ，有效期3650天。</p><p>当然，用AS打包的过程中也可以使用图形化界面创建一个新的签名。<br><br><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/new-key-store.jpg" alt="image"></p><ol start="2"><li>进行数字签名</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jarsigner -keystore demo.jks -signedjar xxx_signed.apk xxx.apk demo</span><br></pre></td></tr></table></figure><p>以上命令就会用 demo.jks 为 xxx.apk 签名，签名后的文件为xxx_signed.apk</p><ol start="3"><li>验证签名</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jarsigner -verify xxx_signed.apk</span><br></pre></td></tr></table></figure><p>验证一个已签名的 apk 文件，如果签名的 apk 文件没有被篡改过，那么就会显示已验证。否则，会抛出<code>SecurityException</code>，表明哪些文件没有通过验证。</p><p>还可以用<code>java.util.jar</code>和<code>java.securityAPI</code>以编程方式签名JAR，这里就不做介绍了。</p><h3 id="3-3-原理"><a href="#3-3-原理" class="headerlink" title="3.3 原理"></a>3.3 原理</h3><blockquote><p>jar 签名是如何校验文件的合法性呢？</p></blockquote><p>通过解压软件打开签名后的apk文件，就会发现里面包含了 dex 字节码文件，清单文件，资源文件等。结构就如下图所示，其中 META-INF/MANIFEST.MF 文件包含每个文件的摘要信息。<br></p><p><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/signed-apk.jpg" alt=""></p><p>可以看到我在图中圈出来了两个文件，他们就是在签名时生成的。</p><ol><li>签名文件 <code>META-INF/&lt;signer&gt;.SF</code>：包含MANIFEST中每个摘要项的摘要，使用私钥加密</li><li>签名块文件 <code>META-INF/&lt;signer&gt;.(RSA|DSA|EC)</code>：包含 .SF 文件的签名和来自密钥仓库的证书或证书链。其中证书包含了签名者的有关信息和 public key</li></ol><p><em>如果命令行中没有 -sigfile 选项，则上述的<signer>将是命令行中指定的别名的前 8 个字符，并全部被转换为大写；而<signer>.(RSA|DSA|EC)的扩展名，根据数字签名的类型RSA、DSA 或者 PGP 以及用于签名 JAR 的证书类型而有不同的扩展名。</signer></signer></em></p><p>这些文件的关系如下图：<br><br><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/Scheme1v2.png" alt=""></p><p>签名的过程就是获取MANIFEST文件中每一项的摘要，再用私钥加密后保存下来。校验签名的时候，首先对 jar 中每个文件进行摘要计算，然后与MANIFEST中已记录的摘要进行比较，来判断文件是否更改过。同时还要计算MANIFEST文件中每项的摘要，并与签名文件中的每一项（用公钥解密后）比较，以验证MANIFEST文件是否被修改过。</p><p><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/verify_sha.png" alt=""></p><h3 id="3-4-存在的问题"><a href="#3-4-存在的问题" class="headerlink" title="3.4 存在的问题"></a>3.4 存在的问题</h3><ol><li>正如上面介绍的，v1签名会校验 APK 中每个文件的合法性，但并不包含META-INF目录中的文件，而且也不能保护 APK 的某些部分，例如 ZIP 元数据。<br></li></ol><p><em>由于v1签名的这个问题出现的一些漏洞，如 <a href="https://www.guardsquare.com/en/blog/new-android-vulnerability-allows-attackers-modify-apps-without-affecting-their-signatures" target="_blank" rel="noopener">Janus 漏洞</a>、MasterKey 漏洞、“9695860”漏洞、“9950697”漏洞，感兴趣的朋友可以去查查看，看完后不禁感慨这些黑客真的是聪明。</em><br>2. APK 验证程序必须解压所有已压缩的条目，而这需要花费更多时间和内存。</p><p>ps：插播一条，也正是由于v1签名存在的第一个“问题”，在v2签名出现前，许多多渠道打包工具就是将渠道信息写入META-INF目录中的文件，或者是zip文件元数据来实现快速地多渠道打包。如 <a href="https://github.com/mcxiaoke/packer-ng-plugin/tree/v1.0.9" target="_blank" rel="noopener">PackerNg</a> ，将渠道信息写入zip文件元数据的注释部分，需要时从文件中读出，这样不会影响签名的校验，相比<code>productFlavors</code>大大提高了渠道包的打包速度。</p><h2 id="四、v2方案"><a href="#四、v2方案" class="headerlink" title="四、v2方案"></a>四、v2方案</h2><blockquote><p>正是为了解决v1签名存在的问题，Android 7.0 中引入了 APK 签名方案 v2</p></blockquote><h3 id="4-1-工具介绍"><a href="#4-1-工具介绍" class="headerlink" title="4.1 工具介绍"></a>4.1 工具介绍</h3><p>v1签名的工具是jdk提供的，在Android SDK Build Tool 24.0.3 及更高版本中提供了<code>apksigner</code>工具，可以使用此工具来为APK签名，apksigner默认是同时支持V1与V2的。详细介绍可以查看 <a href="https://developer.android.com/studio/command-line/apksigner" target="_blank" rel="noopener">官方文档-apksigner</a>（需要科学上网）</p><h3 id="4-2-签名步骤"><a href="#4-2-签名步骤" class="headerlink" title="4.2 签名步骤"></a>4.2 签名步骤</h3><ol><li>进行数字签名</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apksigner sign --ks keystore.jks |</span><br><span class="line">      --key key.pk8 --cert cert.x509.pem</span><br><span class="line">      [signer_options] app-name.apk</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; demo      </span><br><span class="line">apksigner sign --ks demo.jks --ks-key-alias demo --out Demo_signed.apk Demo.apk</span><br></pre></td></tr></table></figure><ol start="2"><li>验证签名</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apksigner verify [options] app-name.apk</span><br></pre></td></tr></table></figure><h3 id="4-3-原理"><a href="#4-3-原理" class="headerlink" title="4.3 原理"></a>4.3 原理</h3><p>与v1签名对压缩包内的部分文件进行保护不同，v2签名是一种全文件签名方案，使用 方案 v2 进行签名时，会在 APK 文件中插入一个 APK 签名分块，该分块位于“ZIP 中央目录”部分之前并紧邻该部分。在“APK 签名分块”内，v2 签名和签名者身份信息会存储在 APK 签名方案 v2 分块中。<br><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/apk-before-after-signing.png" alt="apk签名前和签名后"><br>此时APK包含以下4各部分：</p><ol><li>ZIP 条目的内容（从偏移量 0 处开始一直到“APK 签名分块”的起始位置）</li><li>APK 签名分块</li><li>ZIP 中央目录</li><li>ZIP 中央目录结尾</li></ol><p><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/apk-sections.png" alt="签名后APK4部分"></p><p>APK 签名方案 v2 负责保护第 1、3、4 部分的完整性，以及第 2 部分包含的“APK 签名方案 v2 分块”中的<code>signed data</code>分块的完整性。<code>signed data</code>分块是什么呢？这就要说说v2签名是怎么进行全文件的摘要计算。下图就展示了计算方式，这张图可以从下往上看。</p><p><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/apk-integrity-protection.png" alt="APK摘要计算方法"></p><ol><li>第1、3、4部分，每个部分都会被拆分成多个大小为 1 MB 的连续块（每个部分的最后一个块可能会短一些）。</li><li>计算每个小块（字节 0xa5 + 块长度 + 块内容）的摘要，即图中第二层“Digests of chunks”。</li><li>计算整体（字节 0xa5 + 块数量 + 每个块的摘要）的摘要。</li></ol><p>为什么要分成一个个小块分别计算而不直接计算整个文件的呢？是因为以分块的方式计算摘要，就可以通过并行处理来加快计算速度。</p><p>现在文件的摘要有了，那存储在哪呢？接下来就介绍APK的第2部分-APK Signing Block。</p><p>签名块的格式如下（所有数字字段均采用小端字节序）：</p><ol><li>size of block，以字节数（不含此字段）计 (uint64)</li><li>“ID-值”对序列：<ol><li>“ID-值”对的长度 (uint64)</li><li>ID (uint32)</li><li>value（可变长度：“ID-值”对的长度 - 4 个字节）</li></ol></li><li>size of block，以字节数计 - 与第一个字段相同 (uint64)</li><li>magic “APK Sig Block 42”（16 个字节）</li></ol><p>这里有一个乍看有点奇怪的地方，块的大小前后都存了一次，我的理解是：在解析 APK 时，由于ZIP前面的内容部分长度不确定，如果从前往后要找到签名块会比较困难。从后往前就会容易些：</p><ol><li>在文件末尾找到“ZIP 中央目录结尾”记录，然后从该记录中读取“中央目录”的起始偏移量。</li><li>如果“中央目录”前面是 magic 值-“APK Sig Block 42”，可以快速确定“中央目录”前方可能是“APK 签名分块”。</li><li>通过 size of block 值，可以高效地找到该分块在文件中的起始位置。</li></ol><p><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/find-sign-block.jpg" alt="查找签名块"></p><p>找到签名分块后就可以解析出其中的多个“ID-值”对，APK 的 v2 签名会存储为一个“ID-值”对，其中 ID 为 <code>0x7109871a</code>。当然，签名块中还可以存储后续可能出现的V3、V4 … Vn签名。在ID<code>0x7109871a</code>对应的值（v2分块）中就存储着前面计算出的摘要、X.509证书、公钥等等，v2分块的具体格式可以查看<a href="https://source.android.google.cn/security/apksigning/v2" target="_blank" rel="noopener">官方文档-APK 签名方案 v2</a>，在后面说到v3签名的时候会有张我画的结构图。</p><h3 id="4-4-防回滚保护"><a href="#4-4-防回滚保护" class="headerlink" title="4.4 防回滚保护"></a>4.4 防回滚保护</h3><p>APK 签名方案 v2 是在 Android 7.0 (Nougat) 中引入的，为了使 APK 可在 Android 6.0 (Marshmallow) 及更低版本的设备上安装，应先使用 JAR 签名功能对 APK 进行签名，然后再使用 v2 方案对其进行签名。</p><p>v2签名解决了v1签名无法保护部分文件内容的问题，所以在7.0及以上的系统，我们肯定是希望使用v2签名验证的。但是由于APK里也包含v1签名，某些攻击者就可以移除掉v2签名的部分，让系统只验证v1签名。为了防范此类攻击，带 v2 签名的 APK 如果还带 v1 签名，其 META-INF/*.SF 文件的主要部分中必须包含 X-Android-APK-Signed 属性。<br><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/x-android-apk-signed.jpg" alt="X-Android-APK-Signed 属性"></p><p>该属性的值是一组以英文逗号分隔的 APK 签名方案 ID（v2 方案的 ID 为 2）。在验证v1签名时，如果发现首选的签名方案是v2，但是APK不包含v2签名，则直接验证失败。由于 META-INF/*.SF 文件受 v1 签名保护，攻击者没法修改该文件中的X-Android-APK-Signed 属性。</p><h3 id="4-5-验证优先级"><a href="#4-5-验证优先级" class="headerlink" title="4.5 验证优先级"></a>4.5 验证优先级</h3><p><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/apk-v2-validation.png" alt=""><br><br>在7.0以下版本的平台，会忽略v2签名，只验证v1签名。在7.0及以上版本平台上，会判断如果有v2签名，则验证v2签名，如果没有，则验证v1签名。</p><h3 id="4-6-渠道包方案"><a href="#4-6-渠道包方案" class="headerlink" title="4.6 渠道包方案"></a>4.6 渠道包方案</h3><p>早期使用的在zip文件的注释部分写入渠道信息的方案，对于v2签名显然是不可行的，会导致签名验证不通过。但是v2签名引入了“签名块”，“签名块”中包含了很多“ID-值”对，我们可以添加一个自己的“ID-值”对，值就是渠道信息，要获取渠道的时候通过我们自定义的ID去找到就行了，v2签名后<code>walle</code>的新版本就是基于这个原理。</p><h2 id="五、v3方案"><a href="#五、v3方案" class="headerlink" title="五、v3方案"></a>五、v3方案</h2><p>生成签名的时，可以指定一个有效时间，这个时间默认为 25 年，并且 Google Play 也有硬性规定，上架的 App 签名有效期必须在 2033-10-22 之后。所以只要不是手欠修改了这个有效期，距离过期还早着呢，毕竟 Android 系统也才10年左右。</p><p>==但是，我实际测试了下官方模拟器、小米、vivo、华为荣耀，签名已失效依然可以正常安装。== 网上千篇一律都说失效签名无法安装，不知道他们有没有实际测过。咨询了厂商的开发者，目前只收到了vivo的回复，说是因为手机时间可以随意调，所以这个检验没有任何意义，他们废弃掉了，其他厂商不知道是不是也出于这个原因。</p><p>但是，保不准出现某个厂商会校验、或者某一天华米OV这些厂商也开始校验了、又或者公司收购等等需要更换签名的情况，需求是真实存在的。对于一款上架的 App，当签名失效之后，我们只能被迫换签名，此时因为签名校验无法通过，就会导致旧用户无法覆盖安装。这些历史用户唯一的选择，就是卸载后重新安装，这个代价显然是太大了。</p><p>不过不用担心，Google已经解决了这个问题，就是 Android 9.0 新增的 APK 签名v3。Android 9 支持 APK 密钥轮转，这使应用能够在 APK 更新过程中更改其签名密钥。</p><h3 id="5-1-v3分块"><a href="#5-1-v3分块" class="headerlink" title="5.1 v3分块"></a>5.1 v3分块</h3><p>v3签名并没有像v1→v2那样大的变化，可以算是v2的升级版。v3分块和v2分块一样存储在“APK签名分块”中，ID 为<code>0xf05368c0</code>，格式与v2相同，只是增加了支持的 SDK 版本（minSDK、maxSDK）和 Proof-of-rotation 信息。想了解完整的结构，可以查看<a href="https://source.android.google.cn/security/apksigning/v3" target="_blank" rel="noopener">官方文档-APK 签名方案 v3</a>。</p><p>Proof-of-rotation 结构位于<code>signed data</code>的“其他属性”中，ID 为<code>0x3ba06f8c</code>，其中包含一个单链表，每个节点都包含用于为之前版本的应用签名的签名证书。该单链表按版本排序，最旧的签名证书对应于根节点。系统会让每个节点中的证书为列表中的下一个证书签名，从而为每个新密钥提供证据来证明它应该像旧密钥一样可信。</p><p><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/Lineage.png" alt=""></p><p>为了让大家更直观的了解签名分块的结构，我画了张图。</p><p><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/APK-sign-block.jpg" alt=""></p><h3 id="5-2-验证优先级"><a href="#5-2-验证优先级" class="headerlink" title="5.2 验证优先级"></a>5.2 验证优先级</h3><p>同样，为了兼容老版本，在 Android 9 及更高版本中，可以根据 APK 签名方案 v3、v2 方案或 v1 方案验证 APK。较旧的平台会忽略 v3 签名并尝试验证 v2 签名，然后验证 v1。<br><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/apk-validation-process.png" alt="image"></p><h3 id="5-3-轮替（更换）签名密钥"><a href="#5-3-轮替（更换）签名密钥" class="headerlink" title="5.3 轮替（更换）签名密钥"></a>5.3 轮替（更换）签名密钥</h3><p>下面就介绍下怎么更换签名，前提当然是你手上有老的签名和密码。</p><ol><li>创建支持密钥轮替的签名证书链（我自己的翻译，官方文档翻译成“签名证书沿袭”，感觉也是机翻的…）：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apksigner rotate --out &#x2F;path&#x2F;to&#x2F;new&#x2F;file --old-signer \</span><br><span class="line">      --ks release.jks --new-signer --ks release2.jks</span><br></pre></td></tr></table></figure>使用以上命令，设置输出的证书链文件名，然后会提示输入老签名密码，新签名密码，就会生成证书链文件。</li></ol><p>如果要再次更换签名密钥，就再加一个–in，也就是之前的证书链：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apksigner rotate --in &#x2F;path&#x2F;to&#x2F;existing&#x2F;lineage \</span><br><span class="line">      --out &#x2F;path&#x2F;to&#x2F;new&#x2F;file --old-signer --ks release2.jks \</span><br><span class="line">      --new-signer --ks release3.jks</span><br></pre></td></tr></table></figure><ol start="2"><li><p>签名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apksigner sign -lineage &#x2F;path&#x2F;to&#x2F;lineage -ks release.jks \</span><br><span class="line">      -next-signer -ks release2.jks -out signed.apk unsign.apk</span><br></pre></td></tr></table></figure><p>此时就要证书链，老证书，新证书都配置上。暂时还只知道命令行的方式签名，AS可视化的似乎还没有加上这个功能，不过这毕竟也是一个小众的需求。</p></li><li><p>测试</p></li></ol><p>经测试，安装了release.jks签名的包，可以正常覆盖安装第二步生成的签名包，后续就可以直接覆盖安装仅用release1.jks签名的包了，说明签名确实更换成功了。==但是，用户并不一定都更新了轮替签名的包，可能跨版本升级，所以我觉得后续的所有包都得按照第2步的来打，不能仅用新签名release1.jks。== 除非能够确认已经没有用户在使用release.jks签名的包了。</p><h2 id="六、其它"><a href="#六、其它" class="headerlink" title="六、其它"></a>六、其它</h2><h3 id="6-1-遇到的一个异常"><a href="#6-1-遇到的一个异常" class="headerlink" title="6.1 遇到的一个异常"></a>6.1 遇到的一个异常</h3><p><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/v3SignatureError.jpg" alt="v3SignatureError"></p><p>上面这个异常出现在我公司某个版本临近上线时，9.0以下机型都可以正常安装，但是9.0及以上就无法安装。我当时也是很懵逼啊，这个版本没做什么改动啊。log显示是v3签名校验不通过，这就说得通了，9.0以上才会校验v3签名。又发现未加渠道号的没问题，加了渠道号就有问题了，当时渠道包是用 <a href="https://github.com/mcxiaoke/packer-ng-plugin" target="_blank" rel="noopener">packer-ng-plugin</a> 这个工具打的，那肯定就是这个工具还没有兼容v3签名。packer-ng-plugin 读写渠道号，其实使用的就是美团的 <a href="https://github.com/Meituan-Dianping/walle" target="_blank" rel="noopener">walle</a>，walle其实已经在今年2月份就修复了这个问题。原因就是Android 9 需要 apk 签名块的长度确保为 4096 的倍数。查看源码<code>/frameworks/base/core/java/android/util/apk/ApkVerityBuilder.java</code>可以找到下面这段校验代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CHUNK_SIZE_BYTES = <span class="number">4096</span>;  <span class="comment">// Typical Linux block size</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">assertSigningBlockAlignedAndHasFullPages</span><span class="params">(SignatureInfo signatureInfo)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 省略部分代码……</span></span><br><span class="line">  <span class="keyword">if</span> ((signatureInfo.centralDirOffset - signatureInfo.apkSigningBlockOffset)</span><br><span class="line">          % CHUNK_SIZE_BYTES != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">              <span class="string">"Size of APK Signing Block is not a multiple of 4096: "</span></span><br><span class="line">              + (signatureInfo.centralDirOffset - signatureInfo.apkSigningBlockOffset));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里抛出的异常就是上面控制台显示的。so，使用最新的 walle 就行。</p><h3 id="6-2-忘记签名密码怎么办？"><a href="#6-2-忘记签名密码怎么办？" class="headerlink" title="6.2 忘记签名密码怎么办？"></a>6.2 忘记签名密码怎么办？</h3><p>网上说的通过查看Android Studio Log文件找回，亲测已经不行了，log中的password都是<code>******</code>。</p><p>推荐个工具 <a href="http://maxcamillo.github.io/android-keystore-password-recover/" target="_blank" rel="noopener">Android-keystore-password-recover</a>，提供了3种方式：</p><ol><li><strong>暴力破解</strong>：顾名思义，就是一个个试，最不推荐，实在没办法了在尝试这个。</li><li><strong>字典破解</strong>：提供一些可能的密码放到一个txt文件中，一个个尝试字典中的密码。</li><li><strong>智能字典破解</strong>：==推荐== 提供一些密码中可能的片段，放到一个txt文件中，它会将这些片段进行组合，并尝试出正确的密码。</li></ol><p>我自己曾经就通过类似的工具找到了忘记的密码，如果能想到的片段可能组合成正确的密码，几乎是一瞬间就试出来了。</p><p><img src="http://android-tech.oss-cn-shenzhen.aliyuncs.com/signature/keystore-password-recover.jpg" alt="image"></p><h3 id="6-3-签名丢了怎么办？"><a href="#6-3-签名丢了怎么办？" class="headerlink" title="6.3 签名丢了怎么办？"></a>6.3 签名丢了怎么办？</h3><p>收拾收拾准备跑路吧！</p><p>保管好签名文件！保管好签名文件！保管好签名文件！重要的事情说三遍</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Android/" rel="tag"># Android</a> <a href="/tags/%E7%AD%BE%E5%90%8D/" rel="tag"># 签名</a></div><div class="post-nav"><div class="post-nav-item"><a href="/DataBinding.html" rel="prev" title="DataBinding"><i class="fa fa-chevron-left"></i> DataBinding</a></div><div class="post-nav-item"></div></div></footer></article></div></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、签名是什么？"><span class="nav-text">一、签名是什么？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、预备知识"><span class="nav-text">二、预备知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-非对称加密算法"><span class="nav-text">2.1 非对称加密算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-数字摘要"><span class="nav-text">2.2 数字摘要</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-数字签名"><span class="nav-text">2.3 数字签名</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、v1-方案（jar-签名）"><span class="nav-text">三、v1 方案（jar 签名）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-工具介绍"><span class="nav-text">3.1 工具介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-签名步骤"><span class="nav-text">3.2 签名步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-原理"><span class="nav-text">3.3 原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-存在的问题"><span class="nav-text">3.4 存在的问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、v2方案"><span class="nav-text">四、v2方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-工具介绍"><span class="nav-text">4.1 工具介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-签名步骤"><span class="nav-text">4.2 签名步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-原理"><span class="nav-text">4.3 原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-防回滚保护"><span class="nav-text">4.4 防回滚保护</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-验证优先级"><span class="nav-text">4.5 验证优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-渠道包方案"><span class="nav-text">4.6 渠道包方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、v3方案"><span class="nav-text">五、v3方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-v3分块"><span class="nav-text">5.1 v3分块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-验证优先级"><span class="nav-text">5.2 验证优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-轮替（更换）签名密钥"><span class="nav-text">5.3 轮替（更换）签名密钥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、其它"><span class="nav-text">六、其它</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-遇到的一个异常"><span class="nav-text">6.1 遇到的一个异常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-忘记签名密码怎么办？"><span class="nav-text">6.2 忘记签名密码怎么办？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-签名丢了怎么办？"><span class="nav-text">6.3 签名丢了怎么办？</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">FengShiqian</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">2</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">1</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:fengsq@yeah.net" title="E-Mail → mailto:fengsq@yeah.net" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">FengShiqian</span></div><script>function leancloudSelector(url) {
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = visitors.getAttribute('id').trim();
      var title = visitors.getAttribute('data-flag-title').trim();

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .then(() => {
                leancloudSelector(url).innerText = counter.time + 1;
              })
              .catch(error => {
                console.log('Failed to save visitor count', error);
              })
          } else {
              Counter('post', '/classes/Counter', { title: title, url: url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.log('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return element.getAttribute('id').trim();
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (let item of results) {
            let { url, time } = item;
            leancloudSelector(url).innerText = time;
          }
          for (let url of entries) {
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=8f5qbB4NLF9lxNP9C2evDNsm-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method: method,
          headers: {
            'X-LC-Id': '8f5qbB4NLF9lxNP9C2evDNsm-gzGzoHsz',
            'X-LC-Key': 'efrHK0kwQv0VLCYzjoSLjzGH',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });</script></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el: '#valine-comments',
      verify: false,
      notify: false,
      appId: '8f5qbB4NLF9lxNP9C2evDNsm-gzGzoHsz',
      appKey: 'efrHK0kwQv0VLCYzjoSLjzGH',
      placeholder: "ヾﾉ≧∀≦)o 来呀！快活呀！~",
      avatar: 'mm',
      meta: guest,
      pageSize: '10' || 10,
      visitor: false,
      lang: '' || 'zh-cn',
      path: location.pathname,
      recordIP: false,
      serverURLs: ''
    });
  }, window.Valine);
});</script></body></html>